ARG  DOCKER_REGISTRY
FROM $DOCKER_REGISTRY/spack-base:latest

ARG  ENV
ARG  CONCRETE_ENV
ARG  SPACK_COMPILER
ARG  SPACK_MPI

# Copy environment definition
COPY envs/$ENV/* /build/

# Copy Spack lock file
USER root
COPY artifacts/ci-$CONCRETE_ENV/spack.* /build/
RUN  chmod 755 /build/*.sh

USER mamba
RUN  /build/install-mamba-env.sh

USER spack
RUN  /build/install-spack-env.sh
